<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../th-theme/th-theme.html"> 

<!--
A thelma component providing data utility functions 

##### Example

    <th-data-utility></th-data-utility>

@element th-data-utility
@blurb A thelma component providing data utility functions 
@status alpha
@homepage http://thelmanews.github.io/th-data-utility
-->

<polymer-element name="th-data-utility" attributes="">

  <script src="../lodash/dist/lodash.js"></script>
  <script src="../numeral/numeral.js"></script>

  <script>
    Polymer({
      aggregateFunctions: {
        /*
        'min': function(data, feild) {
          return _.chain(data)
                  .min(function(item) {
                    var n = item[feild];
                    var unformat = numeral().unformat(n);
                    unformat = (unformat===0 && n!==0) ? n : unformat;
                    return unformat;
                  })
                  .pluck(feild)
                  .value();

        },
        */
        'min': function(data, field) {
          return _.reduce(data, function(result, current) {
              return _.min([result, numeral().unformat(current[field])]);
          }, Number.MAX_VALUE);
        },
        'max': function(data, field) {
          return _.reduce(data, function(result, current) {
              return _.max([result, numeral().unformat(current[field])]);
          }, Number.MIN_VALUE);
        },
        'sum': function(data, field) {
          return _.reduce(data, function(result, current) {
              return result + numeral().unformat(current[field]);
          }, 0);
        },
        'avg': function(data, field) {
          return _.reduce(data, function(result, current) {
              return result + numeral().unformat(current[field]);
          }, 0) / (data.length === 0 ? 1 : data.length);
        },
      },
      /**
       * checks if a culomn in data is numerical. 
       * Note! current implementation is too forgiving. unformat function extracts
       * any number within a string so turning 'my1stNumber' to 1.
       * @param  {Array}  data       data in array of objects format
       * @param  {String}  column     column name
       * @param  {Number}  sampleSize Number of samples from from data to be checked.
       * @return {Boolean}            [description]
       */
      isColumnNumeric: function(data, column, sampleSize) {
        if(!sampleSize) {
          sampleSize = Math.min(100, data.length);
        }
        return  _.chain(data)
                 //.clone() //needed? probably not
                 .sample(sampleSize)
                 .pluck(column)
                 .every(function(n) {
                   var unformat = numeral().unformat(n);
                   //numeral.unformat returns 0 for NaN 
                   unformat = (unformat===0 && n!==0) ? n : unformat;
                   return !isNaN(parseFloat(unformat)) && isFinite(unformat);

                 })
                 .value();
      },
      unformatObject: function(obj) {
        var ret = _.clone(obj);
        ret = _.mapValues(obj, function(value) {
          // console.log(value);
          return numeral().unformat(value);
        });
        // console.log(ret);
        return ret;

      },
      unformatString: function(str){
        var ret = _.clone(str);
        return numeral().unformat(ret);
      },
      clone: function(obj, deep) {
        return _.clone(obj, deep);
      }
    });
  </script>
</polymer-element>