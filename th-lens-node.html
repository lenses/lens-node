<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-data-table/th-data-table.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../core-icons/core-icons.html">


<polymer-element name="th-lens-node" attributes="input output componentList type">
  <core-style ref="theme"></theme>
  <template>
    <style>
      #node{
        width: 100%;
        min-height: 100px;
        background-color: white;
        margin: 0 auto;
        box-sizing: border-box;
        padding: 0;
        border: 3px solid #eee;
      }

      #select, #transform {
        min-height: 200px;
        border-bottom: 3px solid #eee;
      }

      core-item::shadow #label{
        padding: 5px;
        background-color: #ddd;
        cursor: pointer;
      }
    </style>
    <div id="node">
      <!-- Common among all nodes -->
      
      <!-- Input node -->
      <template if="{{type=='input'}}">
        <content id="component"></content>
      </template>

      <!-- Transform node -->
      <template if="{{type=='transform'}}">
        <div id="select">
          Select Data:
          <!-- show a datatable with input, with the entire selection made -->
          <th-data-table id="inputTable" input="{{input}}" output="{{componentInput}}"></th-data-table>
        </div>
        
        <div id="transform">
          Transform:
            <!-- Show menu of components to choose from -->
            <template if="{{!component}}">
              <core-menu id="component-list">
                  <core-item class="core-selected" label="None"></core-item>
                <template repeat="{{component in componentList | filterByType}}">
                  <core-item class="{{component.name}}" on-click="{{addElement}}" label="{{component.name}}"></core-item>
                </template>
              </core-menu>
            </template>

            <!-- Name of component selected -->
            <template if="{{component}}">
              <core-item label="{{componentName}}"> <core-icon icon="clear" on-click="{{removeElement}}"> </core-icon>   </core-item>
            </template>

            <!-- Component itself -->
            <content id="component"></content>
        </div>
        
        <div id="view">
          View Result (read only)
            <th-data-table id="outputTable" output="{{componentOutput}}" readOnly="true"></th-data-table>
          <!-- show a datatable with output -->
        </div>
      </template>

      <!-- Visual node -->
      <template if="{{type=='visualize'}}">
                <div id="select">
          Select Data:
          <!-- show a datatable with input, with the entire selection made -->
          <th-data-table id="inputTable" input="{{input}}" output="{{componentInput}}"></th-data-table>
        </div>
        <!-- Show menu of components to choose from -->
        <template if="{{!component}}">
          Choose a visual:
          <core-menu id="component-list">
              <core-item class="core-selected" label="None"></core-item>
            <template repeat="{{component in componentList | filterByType}}">
              <core-item class="{{component.name}}" on-click="{{addElement}}" label="{{component.name}}"></core-item>
            </template>
          </core-menu>
        </template>
        
        <!-- Name of component selected -->
        <template if="{{component}}">
          <core-item label="{{componentName}}"> <core-icon icon="clear" on-click="{{removeElement}}"> </core-icon>   </core-item>
        </template>

        <!-- Component itself -->
        <content id="component"></content>
      </template>
      
    </div>
  </template>

  <script>

      Polymer('th-lens-node', {
      componentInput: [],
      componentOutput: [],
      type: 'transform',

      componentList: [
          {name:'th-array-function', friendly: 'Map/Reduce/Filter Functions', type: 'transform'},
          {name:'th-geocoder-firebase', friendly: 'Geocode Data', type: 'transform'},
          {name:'th-google-map', friendly: 'Google Map', type: 'visualize'},
          {name:'th-n-bar-chart', friendly: 'Bar Chart', type: 'visualize'}
      ],
      domReady: function() {
        var self = this;
        this.component = this.$.component.getDistributedNodes()[1];
        console.log(this.component);

        
      },
      componentInputChanged: function(){
          var self = this;
          console.log("component input changed");
          console.log(self.componentInput);

          if (self.componentInput.length > 0){
            if(self.component){
              self.component.input = self.componentInput;
            } else {
              console.log("output table input changed");
              self.$.outputTable.input = self.componentInput;
              console.log(self.componentInput);
            }
            // console.log("******");
            // console.log(self.componentInput)
            // self.component.input = self.componentInput;
          }
      },
      componentOutputChanged: function(){
        var self = this;
        self.output = self.componentOutput;
      },
      addElement: function(e, detail, selection){
        var self = this;
        self.component = document.createElement(selection.className);
        self.appendChild(self.component);
        
        self.componentName = self.component.tagName.toLowerCase();
        self.setObservers();
      },
      removeElement: function(e, detail, selection){
        var self = this;
        self.removeChild(self.component);
        self.component = null;
        
      },
      setObservers: function(){
        var self = this;

        // Observes changes in the output of the first table, which is the component input
        var componentInputObserver = new PathObserver(self.$.inputTable, 'output').open(function(newValue, oldValue){
          self.component.input = newValue;
        });

        // Observes changes in the output of the component, which is the data in the view table
        var componentOutputObserver = new PathObserver(self.component, 'output').open(function(newValue, oldValue){
          self.$.outputTable.input = self.component ? self.component.output : self.componentInput;            
        })



        // TODO: when transform component changes, view table should reflect that
        // TODO: transformed data should be appended to original data

      },
      componentChanged: function(){
        var self = this;
        if (self.component){
          self.component.input = self.componentInput;
          self.$.outputTable.input = self.component.output;
        } else {
          self.$.outputTable.input = self.componentInput;
        }
      },
      inputChanged: function(){
        var self = this;
        if (self.type == 'visualize'){
          self.componentInput = self.input;
        }
      },
      filterByType: function(value){
        var self = this;
        var componentList = value.filter(function(component){ return component.type == self.type });
        return componentList;
      }
        
      });

  </script>
</polymer-element>
